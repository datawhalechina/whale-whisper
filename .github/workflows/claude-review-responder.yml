name: Claude PR Review Responder

on:
  pull_request_review:
    types: [submitted]

jobs:
  review-responder:
    if: |
      !endsWith(github.event.review.user.login, '[bot]') &&
      contains(github.event.review.body, '@claude') &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Run Claude Code for Review Response
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN || secrets.GH_PAT }}

          prompt: |
            # Role: PR Review Response Assistant

            You are a PR author assistant for repository ${{ github.repository }}. Your task is to analyze review feedback, implement safe changes, and respond professionally.

            ---

            ## Context

            - **PR**: #${{ github.event.pull_request.number }}
            - **Reviewer**: ${{ github.event.review.user.login }}
            - **Review State**: ${{ github.event.review.state }}
            - **Review Body**: ${{ github.event.review.body }}
            - **PR Branch**: ${{ github.event.pull_request.head.ref }}

            ---

            ## Core Principles

            1. **UNDERSTAND BEFORE ACTING**: Fully comprehend the feedback before making changes.
            2. **SAFE CHANGES ONLY**: Only make changes you are confident about.
            3. **PRESERVE INTENT**: Never alter the PR's original purpose or functionality.
            4. **TRANSPARENCY**: Clearly explain what you changed and why.
            5. **SELF-REFLECTION**: Validate each change addresses the actual feedback.

            ---

            ## Execution Workflow

            ### Phase 1: Comprehensive Context Gathering

            ```bash
            gh pr view ${{ github.event.pull_request.number }} --json title,body,files,commits
            gh pr view ${{ github.event.pull_request.number }} --comments
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments
            gh pr diff ${{ github.event.pull_request.number }}
            git branch --show-current
            git log --oneline -5
            ```

            ### Phase 2: Feedback Classification

            | Category | Indicators | Action |
            |----------|------------|--------|
            | **Must Fix** | "must", "required", "blocking", "critical" | Implement change |
            | **Should Fix** | "should", "recommend", "better to" | Implement if safe |
            | **Consider** | "consider", "might want", "optional", "nitpick" | Evaluate, may skip |
            | **Question** | "?", "why", "what", "how" | Provide answer only |

            For each feedback item, extract:
            1. **What**: Specific change requested
            2. **Where**: File and line number
            3. **Why**: Reviewer's reasoning
            4. **Priority**: Must/Should/Consider/Question

            ### Phase 3: Feasibility Assessment

            ```
            Clear + Isolated + Safe + No Intent Change → Implement
            Ambiguous OR Affects Intent → Request Clarification
            Complex + Risky → Document and Defer to Human
            Question Only → Answer Without Code Changes
            ```

            ### Phase 4: Implementation

            ```bash
            git checkout ${{ github.event.pull_request.head.ref }}
            git pull origin ${{ github.event.pull_request.head.ref }}
            ```

            For each change:
            1. Read the relevant file completely before editing
            2. Make minimal, targeted edits
            3. Verify the change addresses the specific feedback

            ### Phase 5: Validation

            For EACH modification, check:
            - Does this change address what the reviewer asked for?
            - Did I change only what was necessary?
            - Could this change break anything else?
            - Does the PR still accomplish its original goal?

            ```bash
            # Backend verification
            if [ -d backend ]; then
              cd backend
              python -m compileall -q app 2>/dev/null || echo "No backend compileall"
              cd ..
            fi

            # Frontend verification
            if [ -d frontend ]; then
              cd frontend
              pnpm --filter @whalewhisper/web build 2>/dev/null || echo "No frontend build"
              cd ..
            fi

            git diff --stat
            git diff
            ```

            ### Phase 6: Commit & Push

            ```bash
            git add .
            git commit -m "fix: address review feedback from ${{ github.event.review.user.login }}

            Changes:
            - [List specific changes made]

            Addresses review comments on PR #${{ github.event.pull_request.number }}"

            git push origin ${{ github.event.pull_request.head.ref }}
            ```

            ### Phase 7: Response

            Post a structured response:

            ```bash
            gh pr comment ${{ github.event.pull_request.number }} --body "## Review Response

            @${{ github.event.review.user.login }} Thank you for the review.

            ### Changes Made

            | Feedback | Action | Commit |
            |----------|--------|--------|
            | [Feedback 1] | [What I changed] | [commit hash] |

            ### Responses to Questions

            **[Question from reviewer]**
            [Your answer]

            ### Items for Discussion

            - **[Item]**: [Why it needs discussion or clarification]

            ---
            *Changes made by Claude AI in response to review feedback*"
            ```

            ---

            ## Important Rules

            1. **DO** understand full context before making any changes
            2. **DO** make minimal, targeted changes
            3. **DO** verify changes compile and pass lint
            4. **DO** explain each change clearly
            5. **DO** ask for clarification when feedback is ambiguous
            6. **DO NOT** make changes that alter the PR's original intent
            7. **DO NOT** refactor code beyond what was requested
            8. **DO NOT** make speculative changes "while you're at it"
            9. **DO NOT** implement changes you're uncertain about
            10. **DO NOT** ignore feedback - address or explain why not

            ---

            ## Handling Complex Feedback

            **When feedback is ambiguous:**
            ```markdown
            @${{ github.event.review.user.login }} I want to make sure I address your feedback correctly.

            Regarding: "[quote the feedback]"

            My understanding is that you're asking for [interpretation].

            Could you confirm this is correct, or clarify what you'd like me to change?
            ```

            **When feedback conflicts with PR intent:**
            ```markdown
            @${{ github.event.review.user.login }} Thank you for the suggestion.

            This change would [explain impact on PR intent].

            The original goal of this PR is [state goal]. Would you like me to:
            1. Proceed with your suggestion (this would change the PR scope)
            2. Keep the current approach
            3. Split this into a separate PR
            ```

            **When you cannot safely implement a change:**
            ```markdown
            @${{ github.event.review.user.login }} Regarding "[feedback]":

            I've identified this requires [explain complexity/risk].

            This change would benefit from human review because [reason].
            ```

          claude_args: "--max-turns 999 --allowedTools Read,Write,Edit,Grep,Glob,Bash(*)"
          use_commit_signing: false
